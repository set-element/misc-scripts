# script to look for CONTENT-TYPE attacks in Apache Struts CVE-2017-5638
# Scott Campbell, scampbell@lbl.gov
#

module HTTP;

@load base/frameworks/notice/main

export {
        redef enum Notice::Type += {
               HTTP_StrutsAttack,     # attack for CVE-2017-5638
        };

	const detection_string = /cmd\.exe|\/bin\/bash|java.lang.ProcessBuilder/ &redef;
}

#hook Notice::policy(n: Notice::Info)
#{
#  if ( n$note == HTTP::HTTP_StrutsAttack )
#        add n$actions[Notice::ACTION_DROP];
#}

event http_header(c: connection, is_orig: bool, name: string, value: string) &priority=5
{
	# look if the connection is from offsite and the value is content-type
        if ( !Site::is_local_addr(c$id$orig_h) && name == "CONTENT-TYPE" && detection_string in value  )
        {
                NOTICE([$note=HTTP_StrutsAttack, $src=c$id$orig_h, $msg=fmt("CVE-2017-5638/Struts attack from %s seen: %s", c$id$orig_h, value)]);

        }

}

